<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIFF Chat</title>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC"; background:var(--bg); color:var(--text); }
    #notice { max-width:720px; margin: 20px auto; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; display:none; }
    #log { position: fixed; left:0; right:0; bottom:0; background:#e2e8f0; border-top:1px solid #cbd5e1; font-size:12px; padding:8px 12px; max-height:140px; overflow:auto; display:none; }
  </style>
</head>
<body>
  <div id="notice"></div>
  <div id="log"></div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Flowise Embedï¼ˆES Module ç‰ˆï¼‰ -->
  <script type="module">
    import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js";

    // ======= éœ€æ›¿æ›ä½ çš„ LIFF IDï¼›Flowise åƒæ•¸å·²å¯ç”¨ =======
    const LIFF_ID = "YOUR_LIFF_ID"; // â† æ›æˆä½ çš„ LIFF ID
    const CHATFLOW_ID = "5e9d71c8-1905-4583-845b-3dfe3b5f4106";
    const FLOWISE_API = "https://cloud.flowiseai.com";
    // =====================================================

    // debug æ—¥èªŒï¼ˆç¶²å€åŠ  ?debug=1 é¡¯ç¤ºï¼‰
    const qs = new URLSearchParams(location.search);
    const showLog = qs.get("debug") === "1";
    const $log = document.getElementById("log");
    const log = (...args) => {
      if (!showLog) return;
      $log.style.display = "block";
      const line = document.createElement("div");
      line.textContent = args.map(x => typeof x === "object" ? JSON.stringify(x) : String(x)).join(" ");
      $log.appendChild(line);
      $log.scrollTop = $log.scrollHeight;
    };
    window.onerror = (m, s, l, c) => log("window.onerror:", m, "@", s, l, c);

    // è®€å–ç¬¬ä¸€é å‚³ä¾†çš„ç‹€æ…‹ï¼ˆå„ªå…ˆ queryï¼Œå…¶æ¬¡ sessionStorageï¼‰
    const mood = qs.get("mood") || sessionStorage.getItem("mood") || "ğŸ™‚";
    const bot = (qs.get("bot") || sessionStorage.getItem("bot") || "").toLowerCase();

    // è‹¥é¸æ“‡çš„ä¸æ˜¯å¯¶åŒ…ï¼Œå…ˆé¡¯ç¤ºæç¤º
    const $notice = document.getElementById("notice");
    if (bot && bot !== "baobao") {
      $notice.style.display = "block";
      $notice.innerHTML = `
        <h3 style="margin:0 0 8px;">ä½ é¸çš„æ˜¯ã€Œè£´å¦®ã€</h3>
        <p style="margin:0 0 8px; color:#374151">ç›®å‰åªæœ‰ã€Œå¯¶åŒ…ã€æ”¯æ´é€™å€‹èŠå¤©é ã€‚ä½ å¯ä»¥ï¼š</p>
        <ul style="margin:0 0 8px 20px; color:#374151">
          <li>è¿”å›ä¸Šä¸€é é‡æ–°é¸æ“‡ã€Œå¯¶åŒ…ã€</li>
          <li>æˆ–å‰å¾€è£´å¦®çš„å°ˆå±¬é ï¼ˆä¹‹å¾Œå¯è£œé€£çµï¼‰</li>
        </ul>
        <button id="back" style="padding:10px 14px; border-radius:10px; border:1px solid #d1d5db; background:#fff;">è¿”å›</button>
      `;
      document.getElementById("back").addEventListener("click", ()=>history.back());
    }

    function startFlowise(sessionId){
      const opener = bot === "baobao"; // åƒ…å¯¶åŒ…æ‰é–‹å•Ÿ Flowise
      if (!opener) return;

      // å°‡å¿ƒæƒ…ä½œç‚ºèŠå¤©é–‹å ´ç™½ï¼ˆçµ¦ Chatflow çš„ system/first message å¯åœ¨ server ç«¯è¿½åŠ ï¼›å‰ç«¯å…ˆå‚³é sessionIdï¼‰
      log("Chatbot.init", { chatflowid: CHATFLOW_ID, apiHost: FLOWISE_API, sessionId, mood });
      // ä½ å¯ä»¥åœ¨ Flowise ç«¯è®€ overrideConfig çš„è‡ªè¨‚æ¬„ä½ï¼›è‹¥éœ€ï¼Œæ”¹æˆ prediction API æ–¹å¼å‚³é
      Chatbot.init({
        chatflowid: CHATFLOW_ID,
        apiHost: FLOWISE_API,
        chatflowConfig: { sessionId },
        theme: {
          chatWindow: {
            title: `å¯¶åŒ… Â· ä»Šå¤©çš„å¿ƒæƒ… ${mood}`,
            welcomeMessage: `å…ˆè¨˜ä¸‹ä½ ä»Šå¤©çš„å¿ƒæƒ… ${mood} ã€‚æƒ³å¾å“ªè£¡é–‹å§‹èŠå‘¢ï¼Ÿ`
          }
        }
      });
    }

    (async () => {
      // ç€è¦½å™¨å¿«é€Ÿæ¸¬è©¦ï¼ˆä¸èµ° LIFFï¼‰
      if (showLog) {
        log("debug=1 â†’ é LINE æ¸¬è©¦");
        startFlowise("debug_user");
        return;
      }
      try {
        log("init LIFF...");
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { log("not logged in â†’ liff.login()"); liff.login(); return; }
        log("getProfile...");
        const profile = await liff.getProfile();
        const sessionId = `line_${profile.userId}`;
        startFlowise(sessionId);
      } catch (err) {
        log("LIFF init error â†’ fallback:", err?.message || err);
        startFlowise();
      }
    })();
  </script>
</body>
</html>
